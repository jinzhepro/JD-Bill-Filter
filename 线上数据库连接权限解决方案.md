# 线上数据库连接权限解决方案

## 问题描述

线上部署成功，但数据库连接失败：

```
Access denied for user 'root'@'18.205.1.161' (using password: YES)
```

## 问题分析

- ✅ 应用程序已成功部署
- ✅ 环境变量已正确加载
- ❌ 数据库用户 'root' 没有从 IP 地址 '18.205.1.161' 连接的权限

## 解决方案

### 方案 1：为特定 IP 地址授权（推荐）

在 MySQL 服务器上执行以下 SQL 命令：

```sql
-- 为root用户授予从特定IP地址连接的权限
GRANT ALL PRIVILEGES ON *.* TO 'root'@'18.205.1.161' IDENTIFIED BY 'Qyt0532$2023';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 方案 2：为所有 IP 地址授权（临时解决方案）

如果需要快速解决，可以允许从任何 IP 连接：

```sql
-- 为root用户授予从任何IP地址连接的权限
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'Qyt0532$2023';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 方案 3：创建专用数据库用户（最佳实践）

为了安全起见，建议创建专用的数据库用户：

```sql
-- 创建专用用户
CREATE USER 'jdws_app'@'18.205.1.161' IDENTIFIED BY 'Qyt0532$2023';

-- 授予数据库权限
GRANT ALL PRIVILEGES ON jdws.* TO 'jdws_app'@'18.205.1.161';

-- 刷新权限
FLUSH PRIVILEGES;
```

如果使用专用用户，需要更新环境变量：

```
DB_USER=jdws_app
```

## 验证步骤

### 1. 检查当前用户权限

在 MySQL 服务器上执行：

```sql
SELECT user, host FROM mysql.user WHERE user = 'root';
```

### 2. 测试连接

执行权限授权后，可以通过以下方式测试连接：

```bash
curl -X POST https://your-domain.com/api/mysql \
  -H "Content-Type: application/json" \
  -d '{"action":"testConnection"}'
```

### 3. 检查应用日志

查看部署平台的日志，确认数据库连接状态。

## 安全建议

1. **使用专用用户**：生产环境不建议使用 root 用户
2. **限制 IP 范围**：只允许特定的应用服务器 IP 连接
3. **定期更新密码**：使用强密码并定期更换
4. **监控连接**：监控数据库连接日志，发现异常连接

## 常见问题

### Q: 为什么 Navicat 可以连接但应用不能？

A: Navicat 可能通过不同的网络路径或使用不同的认证方式连接数据库。

### Q: 如何查看当前连接的 IP 地址？

A: 可以通过应用的诊断 API 查看：

```bash
curl https://your-domain.com/api/db-diagnose
```

### Q: 授权后仍然无法连接？

A: 检查：

1. MySQL 服务器防火墙设置
2. 网络连通性
3. 环境变量是否正确配置

## 紧急联系

如果无法直接访问 MySQL 服务器，请联系数据库管理员执行上述授权命令。
