# JD-Bill-Filter

京东万商对帐单处理系统 - 一个基于 HTML+JavaScript 的 Web 应用，用于自动处理京东万商对帐单 Excel 文件，根据业务规则自动过滤和整理数据。

[![GitHub stars](https://img.shields.io/github/stars/username/JD-Bill-Filter?style=social)](https://github.com/username/JD-Bill-Filter)
[![GitHub forks](https://img.shields.io/github/forks/username/JD-Bill-Filter?style=social)](https://github.com/username/JD-Bill-Filter)
[![GitHub issues](https://img.shields.io/github/issues/username/JD-Bill-Filter)](https://github.com/username/JD-Bill-Filter/issues)
[![GitHub license](https://img.shields.io/github/license/username/JD-Bill-Filter)](https://github.com/username/JD-Bill-Filter/blob/main/LICENSE)

## 功能特性

- 📁 **文件上传**: 支持拖拽上传和点击选择文件（Excel/CSV）
- 🔍 **智能数据解析**: 自动解析 Excel/CSV 文件并验证数据结构
- 📊 **业务规则处理**: 根据预设规则自动过滤数据
- 💰 **商品单价设置**: 根据商品编号去重后设置单价
- 🧮 **总价自动计算**: 自动计算单价 × 数量的总价
- 📈 **处理统计**: 提供详细的数据处理统计信息
- 👀 **数据预览**: 支持处理结果预览
- 💾 **结果导出**: 生成处理后的 Excel 文件并下载（包含单价和总价列）
- 🎨 **友好界面**: 现代化的响应式设计
- ⚡ **实时反馈**: 处理进度和日志实时显示

## 业务规则

### 规则 1：全订单过滤直营服务费

- 当某个订单编号下的所有行都是"订单"类型时
- 自动过滤掉"费用项"为"直营服务费"的行
- 保留其他所有行

### 规则 2：取消退款单全过滤

- 当某个订单编号下的行中包含"取消退款单"类型时
- 过滤掉该订单编号下的所有行
- 不保留任何相关数据

### 规则 3：混合类型保留

- 当订单编号下包含多种单据类型（但不包含取消退款单）时
- 保留所有行，不进行过滤

## 商品单价功能

### 功能说明

在业务规则处理完成后，系统会自动提取所有唯一的商品编号，并为用户提供单价设置界面：

1. **商品去重**: 根据商品编号自动去重，每个商品只显示一次
2. **单价输入**: 用户为每个商品编号设置单价
3. **批量操作**: 支持批量设置相同单价
4. **实时验证**: 输入时实时验证单价格式
5. **进度跟踪**: 显示已设置单价的商品数量
6. **确认应用**: 用户确认后将单价应用到所有相关数据行

### 使用流程

1. **上传文件后**: 系统自动读取文件并显示商品单价设置界面
2. **逐个输入单价**: 为每个商品编号输入对应单价
3. **批量设置**: 可选择批量设置相同单价
4. **开始处理**: 所有商品设置完成后点击"开始处理"按钮
5. **查看结果**: 系统显示包含单价列的最终数据

### 单价验证规则

- 单价必须为数字
- 单价范围：0 - 999999.99
- 支持小数点后两位
- 所有商品必须设置单价才能确认

## 使用方法

### 1. 上传文件

- 点击"选择文件"按钮或直接拖拽文件到上传区域
- 支持 `.xlsx`、`.xls` 和 `.csv` 格式
- 文件大小限制：50MB

### 2. 设置商品单价

- 文件上传成功后，系统自动读取文件并显示商品单价设置界面
- 为每个唯一商品编号设置对应单价
- 支持批量设置相同单价
- 所有商品必须设置单价才能继续处理

### 3. 处理数据

- 所有商品设置完成后点击"开始处理"按钮
- 系统会自动执行以下步骤：
  - 按订单编号分组
  - 应用业务规则过滤
  - 应用单价到所有相关数据行
  - 生成统计信息

### 4. 查看结果

- 处理完成后显示统计信息
- 可以点击"预览数据"查看处理结果（前 100 行）
- 点击"下载处理后的 Excel"获取包含单价列的最终文件

## 技术架构

### 前端技术栈

- **HTML5**: 语义化标记和现代 Web 标准
- **CSS3**: 响应式设计和动画效果
- **JavaScript ES6+**: 现代 JavaScript 特性
- **SheetJS (xlsx)**: Excel 文件解析和生成

### 核心模块

#### 文件处理模块

```javascript
// Excel文件读取
function readExcelFile(file) {
  // 使用FileReader API读取文件
  // 使用SheetJS解析Excel数据
  // 转换为JSON格式
}
```

#### 数据处理模块

```javascript
// 按订单编号分组
function groupByOrderNumber(data) {
  // 将数据按订单编号分组
  // 返回分组后的对象
}

// 应用业务规则
function applyBusinessRules(groupedData) {
  // 遍历每个订单组
  // 检查单据类型
  // 应用相应的过滤规则
}
```

#### 导出模块

```javascript
// 生成Excel文件
function downloadResult() {
  // 创建新的工作簿
  // 添加处理后的数据
  // 生成下载链接
}
```

## 数据结构要求

Excel/CSV 文件必须包含以下列：

| 列名     | 说明       | 示例                     |
| -------- | ---------- | ------------------------ |
| 订单编号 | 唯一标识符 | "202312280001"           |
| 单据类型 | 订单状态   | "订单"、"取消退款单"     |
| 费用项   | 费用分类   | "直营服务费"、"商品费用" |
| 商品编号 | 商品标识   | "PROD001"                |
| 商品数量 | 商品数量   | 1, 2, -1                 |

**输出文件结构**

处理后的 Excel 文件将包含简化的列结构，专注于商品价格和数量统计：

| 列名     | 说明        | 示例      |
| -------- | ----------- | --------- |
| 商品名   | 商品名称    | "iPhone"  |
| 商品编码 | 商品编号    | "PROD001" |
| 单价     | 商品单价    | 10.50     |
| 数量     | 商品数量    | 5         |
| 总价     | 单价 × 数量 | 52.50     |

**注意**: 输出文件只保留核心商品信息，去除了原始的订单编号、单据类型等字段，专注于商品价格和数量统计。

## 错误处理

系统会处理以下错误情况：

1. **文件格式错误**: 非 Excel/CSV 文件格式
2. **文件大小超限**: 超过 50MB 限制
3. **数据结构错误**: 缺少必要的列
4. **空文件处理**: 文件中没有数据
5. **处理异常**: 数据处理过程中的其他错误

## 性能优化

- **异步处理**: 使用 Promise 和 async/await 处理大文件
- **内存管理**: 及时释放不需要的数据
- **进度反馈**: 实时显示处理进度
- **分批处理**: 大文件分批读取和处理

## 浏览器兼容性

- Chrome 60+
- Firefox 55+
- Safari 12+
- Edge 79+

## 项目结构

```
JD-Bill-Filter/
├── index.html          # 主页面
├── styles.css          # 样式文件
├── script.js           # 核心逻辑
├── test-data.csv       # 测试数据
└── README.md           # 说明文档
```

## 快速开始

### 在线使用

1. 直接下载项目文件到本地
2. 用浏览器打开 `index.html` 即可使用

### GitHub 部署

1. Fork 本仓库到你的 GitHub 账户
2. 启用 GitHub Pages
3. 在仓库设置中选择 GitHub Pages 源为 `main` 分支
4. 访问 `https://username.github.io/JD-Bill-Filter` 即可在线使用

### 本地运行

```bash
# 克隆仓库
git clone https://github.com/username/JD-Bill-Filter.git

# 进入项目目录
cd JD-Bill-Filter

# 用浏览器打开
open index.html
```

## 使用示例

### 输入数据示例

| 订单编号 | 单据类型   | 费用项     | 金额 |
| -------- | ---------- | ---------- | ---- |
| ORD001   | 订单       | 直营服务费 | 10   |
| ORD001   | 订单       | 商品费用   | 100  |
| ORD002   | 订单       | 直营服务费 | 15   |
| ORD002   | 取消退款单 | 退款       | -100 |
| ORD003   | 订单       | 商品费用   | 200  |
| ORD003   | 订单       | 其他费用   | 5    |

### 处理结果示例

| 订单编号 | 单据类型 | 费用项   | 金额 |
| -------- | -------- | -------- | ---- |
| ORD001   | 订单     | 商品费用 | 100  |
| ORD003   | 订单     | 商品费用 | 200  |
| ORD003   | 订单     | 其他费用 | 5    |

### 处理说明

- **ORD001**: 全是订单，过滤掉直营服务费行
- **ORD002**: 包含取消退款单，过滤整个订单组
- **ORD003**: 混合类型，保留所有行

## 更新日志

### v1.0.0 (2023-12-28)

- 初始版本发布
- 实现基本的 Excel 文件处理功能
- 支持业务规则 1 和规则 2
- 添加数据预览和下载功能

## 许可证

MIT License

## 联系方式

如有问题或建议，请联系开发团队。

---

**注意**: 本系统仅在浏览器本地运行，不会上传任何数据到服务器，确保数据安全。
