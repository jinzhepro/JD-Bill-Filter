# 京东万商对帐单处理系统 - Next.js 版本

一个基于 Next.js + React + Tailwind CSS 的现代化 Web 应用，用于自动处理京东万商对帐单 Excel 文件，根据业务规则自动过滤、统计和整理数据。

## 功能特性

- 📁 **文件上传**: 支持拖拽上传和点击选择文件（Excel/CSV）
- 🔍 **智能数据解析**: 自动解析 Excel/CSV 文件并验证数据结构
- 🔄 **订单数据处理**: 自动处理订单和取消退款单数据
- 🧮 **智能合并**: 相同商品编码和单价的记录自动合并金额和数量
- 💰 **单价自动计算**: 根据货款和运费自动计算商品单价
- 🚫 **无效数据过滤**: 自动过滤总价为 0 的无效记录
- 📊 **处理统计**: 提供订单数量、商品总数和总金额的统计信息
- 👀 **结果预览**: 支持处理结果预览，只显示关键字段
- 💾 **简化导出**: 生成包含 5 个字段的 Excel 文件（商品名称、商品编号、单价、数量、总价）
- 🎨 **现代化界面**: 响应式设计，简洁的用户体验
- ⚡ **实时反馈**: 处理进度和日志实时显示

## 技术栈

- **框架**: Next.js 14+ (App Router)
- **UI 库**: Tailwind CSS
- **语言**: JavaScript
- **状态管理**: React Hooks + Context API
- **文件处理**: SheetJS (xlsx)
- **构建工具**: Next.js

## 快速开始

### 安装依赖

```bash
npm install
```

### 启动开发服务器

```bash
npm run dev
```

在浏览器中打开 [http://localhost:3000](http://localhost:3000) 查看应用。

### 构建生产版本

```bash
npm run build
npm start
```

## 使用方法

### 1. 上传文件

- 点击"选择文件"按钮或直接拖拽文件到上传区域
- 支持 `.xlsx`、`.xls` 和 `.csv` 格式
- 文件大小限制：50MB

### 2. 自动处理

- 文件上传成功后，系统自动开始处理数据
- 处理步骤包括：
  - 筛选订单和取消退款单数据
  - 合并相同订单的商品信息
  - 自动计算商品单价和总价
  - 合并相同商品编码和单价的记录
  - 过滤无效数据（总价为 0 的记录）

### 3. 查看结果

- 处理完成后显示统计信息（订单数量、商品总数、总金额）
- 数据表格显示处理结果，包含 5 个关键字段
- 点击"下载 Excel 结果"获取最终文件
- 点击"重新上传"可以处理新文件

## 处理逻辑

### 数据处理流程

1. **数据筛选**: 筛选单据类型为"订单"和"取消退款单"的数据
2. **订单分组**: 按订单编号分组，合并同一订单的商品信息
3. **费用合并**: 合并货款和运费信息，计算商品总价和单价
4. **智能合并**: 合并相同商品编码和单价的记录，累加金额和数量
5. **数据过滤**: 过滤掉总价为 0 的无效记录
6. **结果生成**: 生成包含 5 个字段的最终结果

### 计算规则

- **商品单价** = 总价 ÷ 商品数量
- **合并逻辑**: 相同商品编号和单价的记录自动合并
- **数据过滤**: 总价为 0 或 null 的记录会被自动过滤
- **输出字段**: 只保留商品名称、商品编号、单价、商品数量、总价

## 数据结构要求

Excel/CSV 文件必须包含以下列：

| 列名     | 说明       | 示例                                     |
| -------- | ---------- | ---------------------------------------- |
| 订单编号 | 唯一标识符 | "202312280001"                           |
| 单据类型 | 订单状态   | "订单"、"取消退款单"                     |
| 费用项   | 费用分类   | "直营服务费"、"货款"、"合流共配回收运费" |
| 商品编号 | 商品标识   | "PROD001"                                |
| 商品名称 | 商品名称   | "iPhone 15"                              |
| 商品数量 | 商品数量   | 1, 2, 3                                  |
| 金额     | 费用金额   | 100.00, 5.00                             |

**输出文件结构**

处理后的 Excel 文件包含以下 5 个字段：

| 列名     | 说明        | 示例        |
| -------- | ----------- | ----------- |
| 商品名称 | 商品名称    | "iPhone 15" |
| 商品编号 | 商品编号    | "PROD001"   |
| 单价     | 商品单价    | 10.50       |
| 数量     | 最终数量    | 5           |
| 总价     | 单价 × 数量 | 52.50       |

## 项目结构

```
jd-bill-filter-nextjs/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── layout.js          # 根布局
│   │   ├── page.js            # 主页面
│   │   └── globals.css        # 全局样式
│   ├── components/            # React 组件
│   │   ├── ui/               # 基础UI组件
│   │   │   ├── Button.js
│   │   │   └── Modal.js
│   │   ├── FileUpload.js     # 文件上传组件
│   │   ├── ResultDisplay.js  # 结果展示组件
│   │   └── AppContent.js     # 应用内容组件
│   ├── context/              # React Context
│   │   └── AppContext.js
│   ├── lib/                  # 工具库
│   │   ├── dataProcessor.js  # 数据处理逻辑
│   │   └── excelHandler.js   # Excel文件处理
│   └── types/                # 类型定义
│       └── index.js
├── public/                   # 静态资源
│   └── test-data.csv        # 测试数据
├── package.json
├── tailwind.config.js
└── README.md
```

## 测试

项目包含一个测试数据文件 `public/test-data.csv`，您可以下载此文件来测试应用功能。

## 浏览器兼容性

- Chrome 60+
- Firefox 55+
- Safari 12+
- Edge 79+

## 许可证

MIT License

## 更新日志

### v3.1.0 (2024-12-12)

- 🔄 **智能合并功能**: 相同商品编码和单价的记录自动合并金额和数量
- 🚫 **无效数据过滤**: 自动过滤总价为 0 的无效记录
- 💰 **单价自动计算**: 根据货款和运费自动计算商品单价
- 🎨 **界面优化**: 文件上传完成后自动隐藏，简化用户界面
- 📊 **统计信息优化**: 统计信息移至顶部，移除平均单价显示
- 🧮 **精确计算**: 使用 Decimal.js 确保数值计算精度
- 📄 **输出简化**: 最终输出只包含 5 个关键字段
- ⚡ **流程简化**: 移除手动单价设置步骤，实现全自动化处理

### v3.0.0 (2024-12-08)

- 🔄 **完全重构处理逻辑**: 简化为清晰的统计流程
- 🚫 **自动过滤直营服务费**: 自动删除费用项为"直营服务费"的行
- 📊 **订单统计功能**: 统计所有单据类型为"订单"的商品数量
- 🔄 **退款扣减功能**: 根据商品名称扣减退款和售后服务数量
- 💰 **单价输入优化**: 改进商品单价设置界面
- 📄 **简化导出格式**: 导出文件只包含 5 个关键字段
- 🎨 **界面优化**: 简化统计显示，突出重要信息
- ⚡ **性能提升**: 优化数据处理性能和用户体验

### v2.0.0 (2024-12-03)

- 🚀 完全重构为 Next.js 应用
- 🎨 使用 Tailwind CSS 重构 UI
- 📱 优化响应式设计
- ⚡ 提升性能和用户体验
- 🔧 改进错误处理和状态管理
- 📊 增强数据处理能力
- 🔄 新增"代收配送费"过滤条件
- 🐛 修复 React key 重复和事件处理问题

### v1.0.0 (2023-12-28)

- 初始版本发布
- 实现基本的 Excel 文件处理功能
- 支持业务规则 1 和规则 2
- 添加数据预览和下载功能
